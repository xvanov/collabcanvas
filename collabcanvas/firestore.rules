rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Board document - allow authenticated users to create/read/update
    match /boards/{boardId} {
      allow read, write: if request.auth != null;
      
      // Global board shapes collection
      match /shapes/{shapeId} {
        // Auth required for all operations
        allow read: if request.auth != null;
        
        // Create: Validate shape schema and auth
        allow create: if request.auth != null
          // Validate shape type
          && request.resource.data.type in ['rect', 'circle', 'text', 'line', 'polyline', 'polygon']
          // Validate position fields are numbers
          && request.resource.data.x is number
          && request.resource.data.y is number
          && request.resource.data.w is number
          && request.resource.data.h is number
          // Validate color is string
          && request.resource.data.color is string
          // Validate metadata
          && request.resource.data.createdBy == request.auth.uid
          && request.resource.data.updatedBy == request.auth.uid
          // Ensure server timestamps are used
          && request.resource.data.createdAt is timestamp
          && request.resource.data.updatedAt is timestamp
          && request.resource.data.clientUpdatedAt is number
          // Validate layerId is string (optional)
          && (request.resource.data.layerId == null || request.resource.data.layerId is string)
          // Validate type-specific properties
          && (request.resource.data.type == 'rect' 
              || (request.resource.data.type == 'circle' && request.resource.data.radius is number)
              || (request.resource.data.type == 'text' && request.resource.data.text is string && request.resource.data.fontSize is number)
              || (request.resource.data.type == 'line' && request.resource.data.strokeWidth is number && request.resource.data.points is list)
              || (request.resource.data.type == 'polyline' && request.resource.data.strokeWidth is number && request.resource.data.points is list)
              || (request.resource.data.type == 'polygon' && request.resource.data.strokeWidth is number && request.resource.data.points is list));
        
        // Update: Allow position and property updates by authenticated user
        allow update: if request.auth != null
          // Only the user who last updated can update again
          && request.resource.data.updatedBy == request.auth.uid
          // Validate that core fields don't change
          && request.resource.data.type == resource.data.type
          && request.resource.data.createdBy == resource.data.createdBy
          && request.resource.data.createdAt == resource.data.createdAt
          // Validate position fields
          && request.resource.data.x is number
          && request.resource.data.y is number
          && request.resource.data.w is number
          && request.resource.data.h is number
          // Validate color is string
          && request.resource.data.color is string
          // Validate updatedAt timestamp
          && request.resource.data.updatedAt is timestamp
          && request.resource.data.clientUpdatedAt is number
          // Validate type-specific properties remain valid
          && (request.resource.data.type == 'rect' 
              || (request.resource.data.type == 'circle' && request.resource.data.radius is number)
              || (request.resource.data.type == 'text' && request.resource.data.text is string && request.resource.data.fontSize is number)
              || (request.resource.data.type == 'line' && request.resource.data.strokeWidth is number && request.resource.data.points is list)
              || (request.resource.data.type == 'polyline' && request.resource.data.strokeWidth is number && request.resource.data.points is list)
              || (request.resource.data.type == 'polygon' && request.resource.data.strokeWidth is number && request.resource.data.points is list));
        
        // Delete: Allow authenticated users to delete shapes
        allow delete: if request.auth != null;
      }
      
      // Global board layers collection
      match /layers/{layerId} {
        // Auth required for all operations
        allow read: if request.auth != null;
        
        // Create: Basic validation
        allow create: if request.auth != null
          && request.resource.data.name is string
          && request.resource.data.createdBy == request.auth.uid;
        
        // Update: Basic validation
        allow update: if request.auth != null
          && request.resource.data.updatedBy == request.auth.uid;
        
        // Delete: Allow authenticated users to delete layers
        allow delete: if request.auth != null;
      }
    }
    
    // Projects collection - project management system
    match /projects/{projectId} {
      // Helper function to check if user is owner
      function isOwner() {
        return request.auth != null && resource.data.ownerId == request.auth.uid;
      }
      
      // Read: Owner or collaborator (viewer/editor)
      // Note: Firestore rules have limited array iteration capabilities
      // We allow read if user is owner OR if document has collaborators array
      // Application logic will enforce that user is actually in collaborators array
      allow read: if request.auth != null 
        && (isOwner() || resource.data.collaborators != null);
      
      // List: Allow authenticated users to query projects
      // The query itself must filter by ownerId (where('ownerId', '==', userId))
      // We can't check resource.data in list queries, so we allow the query and filter client-side
      allow list: if request.auth != null;
      
      // Create: Authenticated user, must set ownerId to their uid
      allow create: if request.auth != null
        && request.resource.data.ownerId == request.auth.uid
        && request.resource.data.name is string
        && request.resource.data.description is string
        && request.resource.data.status is string
        && request.resource.data.status in ['estimating', 'bid-ready', 'bid-lost', 'executing', 'completed-profitable', 'completed-unprofitable', 'completed-unknown']
        && request.resource.data.collaborators is list
        && request.resource.data.createdBy == request.auth.uid
        && request.resource.data.updatedBy == request.auth.uid;
      
      // Update: Owner or editor collaborator
      // Note: Firestore rules have limited array iteration capabilities
      // We allow update if user is owner OR if document has collaborators array
      // Application logic will enforce that user is actually an editor collaborator
      // For stricter security in production, consider using a Cloud Function
      allow update: if request.auth != null
        && (isOwner() || resource.data.collaborators != null)
        && request.resource.data.ownerId == resource.data.ownerId // Cannot change owner
        && request.resource.data.createdBy == resource.data.createdBy // Cannot change creator
        && request.resource.data.createdAt == resource.data.createdAt; // Cannot change creation time
      
      // Delete: Only owner
      allow delete: if isOwner();
    }
    
    // Deny all other paths
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
