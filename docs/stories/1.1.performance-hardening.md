# Story 1.1: Performance Hardening

## Status
InProgress

## Story
**As a** CollabCanvas product manager,  
**I want** to harden multiplayer performance through automated load testing and targeted optimizations,  
**so that** teams can rely on the app sustaining PRD performance targets in production.

## Acceptance Criteria
1. A repeatable automated harness simulates at least 5 concurrent users manipulating 500 rectangles, captures FPS, shape sync latency, and cursor latency, and runs locally and in CI.
2. Harness executions export metrics suitable for regression gating (e.g., JSON/CSV) and flag failures when median FPS < 60, shape sync latency ≥ 100 ms, or cursor latency ≥ 50 ms.
3. Cross-browser coverage (Chromium + Firefox, with Safari/manual fallback) proves no single-user lag during drag/pan/zoom interactions.
4. Production build instrumentation exposes a lightweight diagnostics HUD with real-time FPS and sync timings for support/QA validation.
5. Under harness load, the optimized app sustains 60 FPS interactions, < 100 ms shape sync, and < 50 ms cursor updates without degrading existing collaboration features.

## Tasks / Subtasks
- [x] Establish automated performance harness (AC1, AC2)
  - [x] Scaffold Playwright-based multi-client runner against Firebase emulators with scripted creation/drag scenarios.
  - [x] Capture FPS via injected `requestAnimationFrame` metrics and network RTT for Firestore/RTDB events.
  - [x] Emit machine-readable reports and CI thresholds that fail on performance regressions.
- [x] Extend coverage and observability (AC2, AC3, AC4)
  - [x] Add cross-browser matrix (Chromium + Firefox) in CI; document Safari manual validation process.
  - [x] Ship diagnostics HUD toggle in app (FPS, outstanding writes, average sync latency).
- [ ] Optimize collaboration paths for target metrics (AC5)
  - [ ] Profile React/Konva rendering, hook subscriptions, and Firebase writes under harness load to isolate hotspots.
  - [ ] Implement prioritized optimizations (e.g., single listener ownership, memoized shape rendering, adaptive throttling) and re-run harness until all thresholds pass.

## Dev Notes
- Performance targets come directly from the MVP PRD requirements (`prd.md:48-53`) and remain non-negotiable for GA.
- Architecture mandates a single Firestore collection listener and RTDB-backed presence/locks (`architecture.md:60-150`); hooks now live solely in `Canvas` so follow-on changes must keep that single-listener pattern intact.
- Firestore writes now include a `clientUpdatedAt` timestamp so the Playwright harness can measure end-to-end sync latency; remember to keep security rules/docs aligned when adjusting schema.
- `Canvas.tsx` already exposes hooks for FPS updates (`collabcanvas/src/components/Canvas.tsx:24-40`); harness instrumentation should extend these callbacks rather than re-implementing measurement.
- Firebase Emulator Suite configuration exists (`firebase.json`, `tasks.md:225-232`); reuse it to avoid hitting production quotas during load tests.

### Testing
- Use Playwright with Firebase emulators to orchestrate concurrent browser contexts; store scripts in `collabcanvas/test/perf/`.
- Collect FPS via injected measurement script (`window.__perfMetrics`) and Firestore/RTDB latency via timestamped hooks; export JSON for CI parsing.
- Run harness in CI on Chromium + Firefox; maintain a manual Safari checklist until WebKit runners stabilize.
- Continue running existing unit/integration suites to guard against functional regressions while optimizing.

## Change Log
| Date       | Version | Description    | Author |
|------------|---------|----------------|--------|
| 2024-05-06 | v0.1    | Initial draft. | John (PM) |

## Dev Agent Record
### Agent Model Used
OpenAI GPT-5 (Codex CLI)

### Debug Log References
None

### Completion Notes List
- Playwright perf harness scaffolded with multi-client scenario, metrics instrumentation, and JSON output gate.
- Refactored Shape interactions to use shared hooks once, added memoization, adaptive throttled flush, and surfaced diagnostics HUD toggle (Shift+D).

### File List
- collabcanvas/package.json
- collabcanvas/src/utils/harness.ts
- collabcanvas/src/hooks/useAuth.ts
- collabcanvas/src/hooks/useShapes.ts
- collabcanvas/src/hooks/usePresence.ts
- collabcanvas/src/components/Canvas.tsx
- collabcanvas/src/components/Shape.tsx
- collabcanvas/src/components/DiagnosticsHud.tsx
- collabcanvas/src/store/canvasStore.ts
- collabcanvas/src/pages/Board.tsx
- collabcanvas/src/types/perfHarness.d.ts
- collabcanvas/test/perf/playwright.perf.config.ts
- collabcanvas/test/perf/tsconfig.json
- collabcanvas/test/perf/specs/performance-harness.spec.ts

## QA Results
_To be completed by QA Agent_
