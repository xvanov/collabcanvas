<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>2</storyId>
    <title>Project-Crew Assignment</title>
    <status>drafted</status>
    <generatedAt>2025-11-19</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint_artifacts/story-fieldpay-integration-2.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>admin</asA>
    <iWant>assign crews to projects with date ranges</iWant>
    <soThat>crew members can clock in to authorized projects and admins can track labor allocation</soThat>
    <tasks>Backend Tasks:
- Create crew assignment service (AC: #2, #3, #4)
- Create assignment API routes (AC: all)
- Assignment validation logic (AC: #3, #4)
- Write backend tests (AC: all)

Frontend Tasks:
- Create crew management service (AC: #1, #2)
- Create crew assignment store (AC: #1, #2)
- Build crew management page (AC: #1, #2, #5)
- Build project-crew assignment component (AC: #2, #3, #4, #5)
- Build crew card component (AC: #1)
- Build crew list component (AC: #1)
- Add validation UI (AC: #3, #4)
- Write frontend tests (AC: all)

Integration Tests:
- Create integration test for complete crew assignment flow (AC: all)</tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">
      <title>Admin can view all crews</title>
      <given>demo crews exist in database</given>
      <when>admin navigates to Crew Management page</when>
      <then>all 3 crews are displayed with foreman name and member count</then>
      <and>each crew card shows active/inactive status</and>
    </criterion>
    <criterion id="AC2">
      <title>Admin can assign crew to project</title>
      <given>admin selects a crew and a project</given>
      <when>admin enters start_date and end_date and clicks "Assign"</when>
      <then>assignment is created in project_crew_assignments table</then>
      <and>success message displays "Crew assigned to [Project Name]"</and>
    </criterion>
    <criterion id="AC3">
      <title>Assignment validation prevents invalid date ranges</title>
      <given>admin is creating assignment</given>
      <when>end_date is before start_date</when>
      <then>error displays "End date must be after start date"</then>
      <and>assignment is not saved</and>
    </criterion>
    <criterion id="AC4">
      <title>Assignment validation prevents overlapping assignments</title>
      <given>crew is already assigned to Project A from 2025-01-15 to 2025-01-31</given>
      <when>admin assigns same crew to Project A from 2025-01-20 to 2025-02-05</when>
      <then>error displays "Crew already assigned to this project during this period"</then>
      <and>assignment is not saved</and>
    </criterion>
    <criterion id="AC5">
      <title>UI shows active and inactive assignments</title>
      <given>assignments exist with past, current, and future dates</given>
      <when>admin views project details</when>
      <then>current assignments (today within date range) are highlighted in green</then>
      <and>past assignments (end_date &lt; today) are grayed out</and>
      <and>future assignments (start_date &gt; today) are shown in blue</and>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-spec.md</path>
        <title>FieldPay-Pro P4P Technical Specification</title>
        <section>Project-Crew Assignment</section>
        <snippet>Admin assigns crews to projects with start/end dates. Enables crew members to clock in to authorized projects. Service layer handles business logic (crewAssignmentService.ts). API routes handle endpoints (routes/assignments.ts). RBAC middleware enforces admin-only access for assignments.</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec.md</path>
        <title>Backend Service Pattern</title>
        <section>Existing Patterns - Service Layer</section>
        <snippet>Each service exports functions (not classes). Use async/await for all async operations. Return objects with {success, data, error} pattern. Log errors with console.error before throwing.</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec.md</path>
        <title>Assignment Validation Logic</title>
        <section>Assignment Edge Cases</section>
        <snippet>Validate start_date &lt; end_date. Query database for existing assignments overlapping date range. Crew assigned to multiple projects same day: Allow (select at clock-in). Assignment end date in past: Mark inactive, prevent clock-in.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>State Management Pattern</title>
        <section>Technology Stack - Zustand</section>
        <snippet>Zustand ^5.0.8 for state management. Store files in src/store/. One store per domain (crewStore.ts). Actions as store methods. TypeScript interfaces for state shape.</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Testing Standards</title>
        <section>Test Framework &amp; Standards</section>
        <snippet>Frontend: Vitest 3.2.4, backend: Jest 29.7.0. Test organization: *.test.ts co-located with source. Coverage target: &gt;80% for services. Mock API calls in tests.</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>Component Strategy</title>
        <section>Component Library</section>
        <snippet>shadcn/ui component library (25 standard components). Custom components co-located by feature. Modern Neutral theme (#0f172a primary). WCAG 2.1 Level AA accessibility compliance.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>collabcanvas/src/services/projectService.ts</path>
        <kind>service</kind>
        <symbol>projectService</symbol>
        <lines>1-50</lines>
        <reason>Reference pattern for Firebase service layer - CRUD operations, Firestore integration, document conversion</reason>
      </artifact>
      <artifact>
        <path>collabcanvas/src/store/projectStore.ts</path>
        <kind>store</kind>
        <symbol>useProjectStore</symbol>
        <lines>1-50</lines>
        <reason>Reference pattern for Zustand store - state management, actions, service integration</reason>
      </artifact>
      <artifact>
        <path>backend/src/server.ts</path>
        <kind>server</kind>
        <symbol>Express server</symbol>
        <lines>all</lines>
        <reason>Backend Express server entry point for API routes</reason>
      </artifact>
      <artifact>
        <path>backend/package.json</path>
        <kind>config</kind>
        <symbol>dependencies</symbol>
        <lines>29-35</lines>
        <reason>Backend dependencies: Express 4.18.2, Firebase Admin 11.11.0, Supabase 2.38.4, CORS, dotenv</reason>
      </artifact>
    </code>
    <dependencies>
      <backend>
        <dependency name="express" version="^4.18.2">Web framework for API routes</dependency>
        <dependency name="@supabase/supabase-js" version="^2.38.4">PostgreSQL database client</dependency>
        <dependency name="firebase-admin" version="^11.11.0">Authentication and admin SDK</dependency>
        <dependency name="cors" version="^2.8.5">Cross-origin resource sharing</dependency>
        <dependency name="dotenv" version="^16.3.1">Environment variables</dependency>
      </backend>
      <frontend>
        <dependency name="zustand" version="^5.0.8">State management</dependency>
        <dependency name="firebase" version="^12.4.0">Frontend Firebase SDK</dependency>
        <dependency name="react" version="^19.2.0">UI framework</dependency>
        <dependency name="typescript" version="~5.9.3">Type safety</dependency>
      </frontend>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Backend service layer: Export functions (not classes), use async/await, return {success, data, error} pattern</constraint>
    <constraint>API routes: Express router pattern, apply middleware (auth → roleCheck → handler), consistent response format</constraint>
    <constraint>RBAC: Only admins can create/update/delete crew assignments</constraint>
    <constraint>Validation: Date validation (start &lt; end), overlap detection (query database for existing assignments)</constraint>
    <constraint>Frontend state: Zustand stores per domain, TypeScript interfaces, actions as methods</constraint>
    <constraint>Frontend components: shadcn/ui components, Modern Neutral theme (#0f172a primary), WCAG 2.1 AA compliance</constraint>
    <constraint>Error handling: Try/catch in async functions, descriptive error messages, toast notifications for users</constraint>
    <constraint>File naming: Components (PascalCase.tsx), services (camelCase.ts), stores (camelCaseStore.ts)</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>GET /api/assignments</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/assignments → Returns all crews with assignments</signature>
      <path>backend/src/routes/assignments.ts</path>
    </interface>
    <interface>
      <name>GET /api/assignments/:projectId</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/assignments/:projectId → Returns assignments for specific project</signature>
      <path>backend/src/routes/assignments.ts</path>
    </interface>
    <interface>
      <name>POST /api/assignments</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/assignments {crewId, projectId, startDate, endDate} → Creates new assignment (admin only)</signature>
      <path>backend/src/routes/assignments.ts</path>
    </interface>
    <interface>
      <name>PUT /api/assignments/:id</name>
      <kind>REST endpoint</kind>
      <signature>PUT /api/assignments/:id {startDate, endDate} → Updates existing assignment (admin only)</signature>
      <path>backend/src/routes/assignments.ts</path>
    </interface>
    <interface>
      <name>DELETE /api/assignments/:id</name>
      <kind>REST endpoint</kind>
      <signature>DELETE /api/assignments/:id → Soft deletes assignment (admin only)</signature>
      <path>backend/src/routes/assignments.ts</path>
    </interface>
    <interface>
      <name>useCrewStore</name>
      <kind>Zustand store</kind>
      <signature>State: crews[], assignments[], loading, error; Actions: loadCrews(), createAssignment(), etc.</signature>
      <path>collabcanvas/src/store/useCrewStore.ts</path>
    </interface>
  </interfaces>
  <tests>
    <standards>Frontend testing: Vitest 3.2.4 for unit tests, co-located *.test.tsx files, expect assertions, vi.mock() for mocking. Backend testing: Jest 29.7.0 for unit tests, tests/*.test.ts structure, supertest for API endpoint testing. Integration testing: Test complete flows, mock Firebase/Supabase calls. Coverage target: &gt;80% for services, &gt;85% for routes. Test data-testid attributes for E2E selector stability.</standards>
    <locations>
      <location>backend/tests/services/crewAssignmentService.test.ts</location>
      <location>backend/tests/routes/assignments.test.ts</location>
      <location>backend/tests/integration/crewAssignment.test.ts</location>
      <location>collabcanvas/tests/components/crew/CrewManagementPage.test.tsx</location>
      <location>collabcanvas/src/services/crewService.test.ts</location>
      <location>collabcanvas/src/store/useCrewStore.test.ts</location>
    </locations>
    <ideas>
      <idea criteriaId="AC1">Test listCrews() returns all crews with member counts and foreman names. Verify active/inactive status display.</idea>
      <idea criteriaId="AC2">Test assignCrewToProject() creates assignment in database with correct dates. Verify success message displayed.</idea>
      <idea criteriaId="AC3">Test date validation rejects end_date before start_date. Verify error message "End date must be after start date".</idea>
      <idea criteriaId="AC4">Test overlap detection: Create assignment, attempt overlapping assignment to same project, verify error "Crew already assigned to this project during this period".</idea>
      <idea criteriaId="AC5">Test assignment status calculation: Past assignments gray, current green, future blue. Mock today's date for consistent testing.</idea>
      <idea criteriaId="all">Integration test: Create crew → Assign to project → Verify in database → Update dates → Delete assignment.</idea>
      <idea criteriaId="all">E2E test: Admin opens crew management → Selects crew → Selects project → Enters dates → Clicks assign → Verifies assignment appears in list.</idea>
      <idea criteriaId="all">RBAC test: Non-admin attempts to assign crew → Receives 403 Forbidden. Admin succeeds with same request.</idea>
    </ideas>
  </tests>
</story-context>
