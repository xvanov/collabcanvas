<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>PC</epicId>
    <storyId>3</storyId>
    <title>Frontend Service Layer</title>
    <status>drafted</status>
    <generatedAt>2025-12-10</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/story-pc-3-frontend-service.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>UI component</asA>
    <iWant>a service layer to call the price comparison Cloud Function</iWant>
    <soThat>I can display comparison results with progress updates</soThat>
    <tasks>
      <task id="1" ac="#1,#3,#4">
        Implement startComparison() function
        <subtask>Create src/services/priceComparisonService.ts</subtask>
        <subtask>Use httpsCallable to call comparePrices Cloud Function</subtask>
        <subtask>Accept projectId, productNames, forceRefresh, zipCode parameters</subtask>
        <subtask>Return Promise&lt;{ cached: boolean }&gt;</subtask>
      </task>
      <task id="2" ac="#2,#5,#6,#7">
        Implement subscribeToComparison() function
        <subtask>Use onSnapshot for Firestore real-time listener</subtask>
        <subtask>Accept callback for ComparisonProgress updates</subtask>
        <subtask>Return unsubscribe function for cleanup</subtask>
      </task>
      <task id="3" ac="#8">
        Implement error handling
        <subtask>Catch network errors</subtask>
        <subtask>Pass errors to error callback</subtask>
        <subtask>Log errors to console</subtask>
      </task>
      <task id="4">
        Implement startMockComparison() convenience function
        <subtask>Use MOCK_PRODUCTS from PC-1</subtask>
        <subtask>Wrap startComparison() with mock data</subtask>
      </task>
      <task id="5" ac="#9">
        Write unit tests
        <subtask>Mock httpsCallable and onSnapshot</subtask>
        <subtask>Test startComparison() parameters and return values</subtask>
        <subtask>Test subscribeToComparison() returns unsubscribe function</subtask>
        <subtask>Test error callback invocation</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1">priceComparisonService.ts exports startComparison() function</ac>
    <ac id="2">priceComparisonService.ts exports subscribeToComparison() function</ac>
    <ac id="3">startComparison() accepts projectId and forceRefresh parameters</ac>
    <ac id="4">startComparison() returns Promise&lt;{ cached: boolean }&gt;</ac>
    <ac id="5">subscribeToComparison() accepts callback for ComparisonProgress updates</ac>
    <ac id="6">subscribeToComparison() returns unsubscribe function for cleanup</ac>
    <ac id="7">Real-time updates fire as each product completes in Firestore</ac>
    <ac id="8">Network errors are caught and passed to error callback</ac>
    <ac id="9">Unit tests pass with mocked Firestore and Cloud Function</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/price-comparison-tech-spec.md</path>
        <title>TrueCost Price Intelligence Module - Technical Specification</title>
        <section>Frontend Service Pattern (Subscription-based)</section>
        <snippet>Use subscribeToComparison() with onSnapshot for real-time Firestore listener. startComparison() triggers Cloud Function, returns { cached: boolean }.</snippet>
      </doc>
      <doc>
        <path>docs/price-comparison-tech-spec.md</path>
        <title>TrueCost Price Intelligence Module - Technical Specification</title>
        <section>Integration Points</section>
        <snippet>Cloud Function callable from frontend via httpsCallable. Firestore path: projects/{projectId}/priceComparison/latest. Frontend subscribes via onSnapshot for live updates.</snippet>
      </doc>
      <doc>
        <path>docs/price-comparison-tech-spec.md</path>
        <title>TrueCost Price Intelligence Module - Technical Specification</title>
        <section>New Type Definitions</section>
        <snippet>ComparisonProgress interface: status, totalProducts, completedProducts, results, startedAt, completedAt, error. CompareRequest: projectId, productNames, forceRefresh, zipCode.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/story-pc-1-types-mock-data.md</path>
        <title>Story PC-1: Types and Mock Data Setup</title>
        <section>Types</section>
        <snippet>Defines ComparisonProgress, CompareRequest, RetailerProduct, MatchResult, ComparisonResult, Retailer types used by the service layer.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/story-pc-2-cloud-function.md</path>
        <title>Story PC-2: Unwrangle + LLM Cloud Function</title>
        <section>Firestore Structure</section>
        <snippet>Firestore path: projects/{projectId}/priceComparison/latest with status, totalProducts, completedProducts, results fields. Updated incrementally after each product completes.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/epic-price-comparison.md</path>
        <title>Epic: Price Intelligence Module</title>
        <section>Stories</section>
        <snippet>PC-3: Frontend Service Layer (Medium complexity). Dependencies: PC-2 (Cloud Function). Creates priceComparisonService.ts for frontend orchestration.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>TrueCost Architecture</title>
        <section>Technology Stack Details</section>
        <snippet>React 19.x, TypeScript 5.x, Firebase SDK 12.4.0 for Auth/Firestore/Functions. Zustand 4.x for state management. Vitest 3.2.4 for testing.</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>collabcanvas/src/types/priceComparison.ts</path>
        <kind>types</kind>
        <symbol>ComparisonProgress, CompareRequest, RetailerProduct, MatchResult, ComparisonResult, Retailer</symbol>
        <lines>1-84</lines>
        <reason>Types to import for service layer - ComparisonProgress for onUpdate callback, CompareRequest for function call</reason>
      </file>
      <file>
        <path>collabcanvas/src/data/mockProducts.ts</path>
        <kind>data</kind>
        <symbol>MOCK_PRODUCTS</symbol>
        <lines>1-23</lines>
        <reason>Mock product array to use in startMockComparison() convenience function</reason>
      </file>
      <file>
        <path>collabcanvas/src/services/pricingService.ts</path>
        <kind>service</kind>
        <symbol>fetchPricesForBOM, withTimeout</symbol>
        <lines>57-130</lines>
        <reason>Reference pattern for progressive updates with callbacks. Use httpsCallable pattern and error handling style.</reason>
      </file>
      <file>
        <path>collabcanvas/src/services/firebase.ts</path>
        <kind>config</kind>
        <symbol>functions, firestore</symbol>
        <lines>44-48</lines>
        <reason>Firebase instances to import - functions for httpsCallable, firestore (as db) for onSnapshot</reason>
      </file>
      <file>
        <path>collabcanvas/functions/src/priceComparison.ts</path>
        <kind>cloud-function</kind>
        <symbol>comparePrices</symbol>
        <lines>354-440</lines>
        <reason>Cloud Function this service calls. Accepts { request: CompareRequest }, returns { cached: boolean }. Writes to Firestore incrementally.</reason>
      </file>
    </code>

    <dependencies>
      <node>
        <package>firebase</package>
        <version>^12.4.0</version>
        <imports>httpsCallable from firebase/functions, doc/onSnapshot from firebase/firestore</imports>
      </node>
      <node>
        <package>react</package>
        <version>^19.2.0</version>
        <imports>Used for component integration (caller)</imports>
      </node>
      <node>
        <package>vitest</package>
        <version>^3.2.4</version>
        <imports>describe, it, expect, vi, beforeEach for unit tests</imports>
      </node>
      <internal>
        <module>src/services/firebase</module>
        <exports>functions, firestore (as db)</exports>
      </internal>
      <internal>
        <module>src/types/priceComparison</module>
        <exports>ComparisonProgress, CompareRequest</exports>
      </internal>
      <internal>
        <module>src/data/mockProducts</module>
        <exports>MOCK_PRODUCTS</exports>
      </internal>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="pattern">Follow existing service pattern from src/services/pricingService.ts - use httpsCallable for Cloud Function calls</constraint>
    <constraint type="pattern">Use onSnapshot from firebase/firestore for real-time subscriptions (not onSnapshot from firestore directly)</constraint>
    <constraint type="pattern">Return unsubscribe function for cleanup in React useEffect</constraint>
    <constraint type="naming">Service file: camelCase with .ts extension (priceComparisonService.ts)</constraint>
    <constraint type="naming">Test file: co-located (priceComparisonService.test.ts)</constraint>
    <constraint type="style">No semicolons (following existing codebase pattern)</constraint>
    <constraint type="style">Single quotes for strings</constraint>
    <constraint type="imports">Import order: external packages first, then internal modules</constraint>
    <constraint type="scope">Don't modify existing services - this is a new file</constraint>
    <constraint type="scope">Import types from src/types/priceComparison.ts (created in PC-1)</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>startComparison</name>
      <kind>function signature</kind>
      <signature>startComparison(projectId: string, productNames: string[], forceRefresh?: boolean, zipCode?: string): Promise&lt;{ cached: boolean }&gt;</signature>
      <path>collabcanvas/src/services/priceComparisonService.ts</path>
    </interface>
    <interface>
      <name>subscribeToComparison</name>
      <kind>function signature</kind>
      <signature>subscribeToComparison(projectId: string, onUpdate: (progress: ComparisonProgress) => void, onError: (error: Error) => void): () => void</signature>
      <path>collabcanvas/src/services/priceComparisonService.ts</path>
    </interface>
    <interface>
      <name>startMockComparison</name>
      <kind>function signature</kind>
      <signature>startMockComparison(projectId: string, forceRefresh?: boolean): Promise&lt;{ cached: boolean }&gt;</signature>
      <path>collabcanvas/src/services/priceComparisonService.ts</path>
    </interface>
    <interface>
      <name>comparePrices Cloud Function</name>
      <kind>REST endpoint (Cloud Function)</kind>
      <signature>httpsCallable(functions, 'comparePrices')({ request: CompareRequest }) => Promise&lt;{ data: { cached: boolean } }&gt;</signature>
      <path>collabcanvas/functions/src/priceComparison.ts</path>
    </interface>
    <interface>
      <name>Firestore Document</name>
      <kind>Firestore path</kind>
      <signature>projects/{projectId}/priceComparison/latest - ComparisonProgress document</signature>
      <path>N/A (Firestore)</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Use Vitest 3.2.4 with React Testing Library 16.3.0. Test files co-located with source (*.test.ts). Mock external dependencies with vi.mock(). Follow existing patterns from pricingService tests. Use describe/it blocks with clear test names. Mock Firebase functions and Firestore with vi.mock().
    </standards>
    <locations>
      <location>collabcanvas/src/services/priceComparisonService.test.ts</location>
      <location>collabcanvas/src/services/*.test.ts (pattern)</location>
    </locations>
    <ideas>
      <idea ac="1,3,4">Test startComparison() calls httpsCallable with correct parameters (projectId, productNames, forceRefresh, zipCode)</idea>
      <idea ac="4">Test startComparison() returns { cached: true } when Cloud Function returns cached response</idea>
      <idea ac="4">Test startComparison() returns { cached: false } for fresh comparison</idea>
      <idea ac="2,6">Test subscribeToComparison() returns unsubscribe function (typeof === 'function')</idea>
      <idea ac="5,7">Test subscribeToComparison() fires onUpdate callback when mock snapshot changes</idea>
      <idea ac="8">Test subscribeToComparison() fires onError callback on subscription error</idea>
      <idea ac="8">Test startComparison() catches network errors and re-throws</idea>
      <idea>Test startMockComparison() calls startComparison() with MOCK_PRODUCTS array</idea>
    </ideas>
  </tests>
</story-context>
