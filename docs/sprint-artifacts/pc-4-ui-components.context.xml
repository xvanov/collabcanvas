<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>price-comparison</epicId>
    <storyId>PC-4</storyId>
    <title>UI Components and Integration</title>
    <status>drafted</status>
    <generatedAt>2025-12-10</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/story-pc-4-ui-components.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user viewing the Material Estimation Panel</asA>
    <iWant>to click a button and see price comparisons in a new tab</iWant>
    <soThat>I can find the best prices across retailers</soThat>
    <tasks>
      <task id="1" acs="3,4,5,6">Create PriceComparisonPage.tsx - Subscribe to Firestore, handle status states (complete/processing/error), progress bar, cleanup subscription</task>
      <task id="2" acs="7">Implement refresh functionality - "Refresh Prices" button with forceRefresh=true</task>
      <task id="3" acs="8,9,10,11">Create PriceComparisonTable.tsx - Display products with retailer columns, highlight best price (green + badge), show "No match found" for nulls, clickable product links</task>
      <task id="4" acs="12">Implement error state - Red message with "Try again" link</task>
      <task id="5" acs="1">Add "Compare Prices" button to MaterialEstimationPanel.tsx</task>
      <task id="6" acs="2">Add route to App.tsx - /compare-prices route, button opens new tab with window.open()</task>
      <task id="7">Manual testing - Run through all acceptance criteria</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1">"Compare Prices" button visible in MaterialEstimationPanel (uses mock projectId)</ac>
    <ac id="2">Clicking button opens new browser tab with /compare-prices</ac>
    <ac id="3">Page subscribes to Firestore for real-time progress updates</ac>
    <ac id="4">If status='complete' -> table displays immediately</ac>
    <ac id="5">If status='processing' -> progress bar shows "Comparing X of Y products..."</ac>
    <ac id="6">Results appear incrementally in table as products complete</ac>
    <ac id="7">"Refresh Prices" button triggers new comparison (forceRefresh=true)</ac>
    <ac id="8">Table displays all products with retailer columns</ac>
    <ac id="9">Best price is highlighted with green background and badge</ac>
    <ac id="10">"No match" cells show gray placeholder</ac>
    <ac id="11">Product links open retailer pages in new tab</ac>
    <ac id="12">Error state displays if status='error'</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/price-comparison-tech-spec.md</path>
        <title>Price Intelligence Module - Technical Specification</title>
        <section>UX/UI Considerations, Visual States, Integration Points</section>
        <snippet>Defines page header layout, progress bar during comparison, comparison table with 3 retailer columns, and visual states for loading/processing/complete/error.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/epic-price-comparison.md</path>
        <title>Epic: Price Intelligence Module</title>
        <section>Stories, Exclusive Files</section>
        <snippet>PC-4 is the final story in this epic. Lists exclusive new files and minor modifications needed.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>TrueCost Architecture</title>
        <section>Project Structure, Frontend Technology Stack</section>
        <snippet>React 19 + TypeScript + Vite frontend, Tailwind CSS styling, shadcn/ui components, Zustand state management.</snippet>
      </doc>
      <doc>
        <path>docs/ux/ux-design-specification.md</path>
        <title>CollabCanvas UX Design Specification</title>
        <section>Design System Foundation, Visual Foundation</section>
        <snippet>Modern Neutral theme with shadcn/ui. Primary: #0f172a, Success: #10b981 (green), Error: #ef4444 (red).</snippet>
      </doc>
      <doc>
        <path>docs/ux/ux-component-library-strategy.md</path>
        <title>Component Library Strategy</title>
        <section>Standard Components, Custom Components</section>
        <snippet>Uses shadcn/ui base components (Table, Button, Progress, Skeleton). Custom BOMTable component provides reference pattern for data tables.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/story-pc-3-frontend-service.md</path>
        <title>PC-3: Frontend Service Layer</title>
        <section>Service Functions</section>
        <snippet>PC-3 provides startComparison(), subscribeToComparison(), and startMockComparison() functions that this story depends on.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/story-pc-1-types-mock-data.md</path>
        <title>PC-1: Types and Mock Data</title>
        <section>Type Definitions</section>
        <snippet>PC-1 provides ComparisonProgress, ComparisonResult, Retailer, RetailerProduct types that this story imports.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>collabcanvas/src/types/priceComparison.ts</path>
        <kind>type-definitions</kind>
        <symbol>Retailer, RetailerProduct, MatchResult, ComparisonResult, ComparisonStatus, ComparisonProgress</symbol>
        <lines>1-84</lines>
        <reason>Core types for price comparison feature. Import these types for component props and state.</reason>
      </file>
      <file>
        <path>collabcanvas/src/services/priceComparisonService.ts</path>
        <kind>service</kind>
        <symbol>startComparison, subscribeToComparison, startMockComparison</symbol>
        <lines>1-73</lines>
        <reason>Service functions to call from UI components. subscribeToComparison returns unsubscribe for useEffect cleanup.</reason>
      </file>
      <file>
        <path>collabcanvas/src/data/mockProducts.ts</path>
        <kind>data</kind>
        <symbol>MOCK_PRODUCTS</symbol>
        <lines>1-23</lines>
        <reason>Mock product array used by startMockComparison. Not directly imported by UI components.</reason>
      </file>
      <file>
        <path>collabcanvas/src/components/MaterialEstimationPanel.tsx</path>
        <kind>component</kind>
        <symbol>MaterialEstimationPanel, MaterialItem</symbol>
        <lines>1-339</lines>
        <reason>Integration point for "Compare Prices" button. Follow existing button patterns (handleRefreshPrices pattern).</reason>
      </file>
      <file>
        <path>collabcanvas/src/App.tsx</path>
        <kind>routing</kind>
        <symbol>App, ProtectedRoute</symbol>
        <lines>1-64</lines>
        <reason>Add new Route for /compare-prices. Follow existing routing patterns with BrowserRouter.</reason>
      </file>
      <file>
        <path>collabcanvas/src/services/firebase.ts</path>
        <kind>service</kind>
        <symbol>firestore, functions</symbol>
        <lines>45-52</lines>
        <reason>Firebase exports used by priceComparisonService. Already imported there, no direct import needed.</reason>
      </file>
    </code>
    <dependencies>
      <frontend>
        <package name="react" version="^19.2.0" />
        <package name="react-dom" version="^19.2.0" />
        <package name="react-router-dom" version="^7.9.5" />
        <package name="firebase" version="^12.4.0" />
        <package name="zustand" version="^5.0.8" />
        <package name="tailwindcss" version="^3.4.18" />
        <package name="typescript" version="~5.9.3" />
      </frontend>
      <testing>
        <package name="vitest" version="^3.2.4" />
        <package name="@testing-library/react" version="^16.3.0" />
        <package name="@testing-library/jest-dom" version="^6.9.1" />
        <package name="@playwright/test" version="^1.50.0" />
      </testing>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="pattern">Use Tailwind CSS for all styling (existing in project)</constraint>
    <constraint type="pattern">Follow existing component patterns in src/components/</constraint>
    <constraint type="pattern">Keep MaterialEstimationPanel.tsx changes minimal (just add button)</constraint>
    <constraint type="pattern">Use window.open() for new tab behavior</constraint>
    <constraint type="pattern">Use React hooks pattern with useEffect for subscription cleanup</constraint>
    <constraint type="pattern">Use existing button styling patterns from MaterialEstimationPanel</constraint>
    <constraint type="naming">Components: PascalCase (PriceComparisonTable.tsx)</constraint>
    <constraint type="naming">No semicolons (following existing pattern)</constraint>
    <constraint type="naming">Single quotes for strings</constraint>
    <constraint type="architecture">Mock projectId (mock-project-001) hardcoded in PriceComparisonPage for now</constraint>
    <constraint type="architecture">Route: /compare-prices (simple route, projectId handled internally)</constraint>
    <constraint type="architecture">subscribeToComparison() returns unsubscribe function - must cleanup in useEffect</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>subscribeToComparison</name>
      <kind>function-signature</kind>
      <signature>subscribeToComparison(projectId: string, onUpdate: (progress: ComparisonProgress) => void, onError: (error: Error) => void): () => void</signature>
      <path>collabcanvas/src/services/priceComparisonService.ts</path>
    </interface>
    <interface>
      <name>startMockComparison</name>
      <kind>function-signature</kind>
      <signature>startMockComparison(projectId: string, forceRefresh?: boolean): Promise&lt;{ cached: boolean }&gt;</signature>
      <path>collabcanvas/src/services/priceComparisonService.ts</path>
    </interface>
    <interface>
      <name>ComparisonProgress</name>
      <kind>type-interface</kind>
      <signature>{ status: ComparisonStatus; totalProducts: number; completedProducts: number; results: ComparisonResult[]; startedAt: number; completedAt?: number; error?: string }</signature>
      <path>collabcanvas/src/types/priceComparison.ts</path>
    </interface>
    <interface>
      <name>ComparisonResult</name>
      <kind>type-interface</kind>
      <signature>{ originalProductName: string; matches: Record&lt;Retailer, MatchResult&gt;; bestPrice: { retailer: Retailer; product: RetailerProduct; savings: number } | null; comparedAt: number; cached: boolean }</signature>
      <path>collabcanvas/src/types/priceComparison.ts</path>
    </interface>
    <interface>
      <name>Retailer</name>
      <kind>type-alias</kind>
      <signature>'homeDepot' | 'lowes' | 'aceHardware'</signature>
      <path>collabcanvas/src/types/priceComparison.ts</path>
    </interface>
    <interface>
      <name>RetailerProduct</name>
      <kind>type-interface</kind>
      <signature>{ id: string; name: string; brand: string | null; price: number; priceReduced?: number | null; currency: string; url: string; imageUrl?: string; rating?: number | null; totalReviews?: number | null; inStock?: boolean; retailer: Retailer }</signature>
      <path>collabcanvas/src/types/priceComparison.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Vitest 3.2.4 for unit/integration tests with React Testing Library 16.3.0 for component testing. Test files co-located with source files using .test.ts/.test.tsx suffix. Mock Firebase functions using vi.mock('firebase/functions'). Playwright 1.50.0 for E2E tests.</standards>
    <locations>
      <location>collabcanvas/src/components/PriceComparisonPage.test.tsx</location>
      <location>collabcanvas/src/components/PriceComparisonTable.test.tsx</location>
      <location>collabcanvas/src/services/priceComparisonService.test.ts (existing)</location>
    </locations>
    <ideas>
      <idea ac="1,2">Test "Compare Prices" button renders in MaterialEstimationPanel and calls window.open with correct URL</idea>
      <idea ac="3">Test subscribeToComparison is called on mount and unsubscribe on unmount</idea>
      <idea ac="4">Test table renders immediately when status='complete'</idea>
      <idea ac="5">Test progress bar renders with correct X of Y text when status='processing'</idea>
      <idea ac="6">Test results table updates as new items are added to progress.results</idea>
      <idea ac="7">Test "Refresh Prices" button calls startMockComparison with forceRefresh=true</idea>
      <idea ac="8">Test table renders all products with 3 retailer columns</idea>
      <idea ac="9">Test best price cell has bg-green-50 class and BEST badge</idea>
      <idea ac="10">Test null match renders "No match found" with gray styling</idea>
      <idea ac="11">Test product links have target="_blank" and rel="noopener noreferrer"</idea>
      <idea ac="12">Test error state renders error message and "Try again" link</idea>
    </ideas>
  </tests>
</story-context>
