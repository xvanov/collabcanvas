{# Cost Breakdown Section - AC 4.3.2
   Contractor mode: Shows detailed costs by CSI division with unit costs, material/labor split
   Client-ready mode: Shows simple category summary only (no unit costs, no detailed breakdown)
#}
<div class="section page-break">
    {% if client_ready %}
    {# ============= CLIENT VIEW - Simple Summary Only ============= #}
    <h2>Cost Summary</h2>

    <p class="text-muted">
        Summary of project costs by major category. All prices are inclusive of materials,
        labor, and applicable fees.
    </p>

    <div class="card">
        <div class="card-header">Project Cost Summary</div>
        <table>
            <thead>
                <tr>
                    <th style="width: 70%;">Category</th>
                    <th class="text-right" style="width: 30%;">Amount</th>
                </tr>
            </thead>
            <tbody>
                {# Simple category summary for clients - no detailed breakdown, no contingency visible #}
                <tr>
                    <td>Cabinetry & Millwork</td>
                    <td class="currency">${{ "{:,.0f}".format(cost_breakdown.cabinetry_total | default(estimate.p80 * 0.25)) }}</td>
                </tr>
                <tr>
                    <td>Countertops & Surfaces</td>
                    <td class="currency">${{ "{:,.0f}".format(cost_breakdown.countertops_total | default(estimate.p80 * 0.15)) }}</td>
                </tr>
                <tr>
                    <td>Flooring</td>
                    <td class="currency">${{ "{:,.0f}".format(cost_breakdown.flooring_total | default(estimate.p80 * 0.12)) }}</td>
                </tr>
                <tr>
                    <td>Plumbing</td>
                    <td class="currency">${{ "{:,.0f}".format(cost_breakdown.plumbing_total | default(estimate.p80 * 0.15)) }}</td>
                </tr>
                <tr>
                    <td>Electrical</td>
                    <td class="currency">${{ "{:,.0f}".format(cost_breakdown.electrical_total | default(estimate.p80 * 0.12)) }}</td>
                </tr>
                <tr>
                    <td>Painting & Finishes</td>
                    <td class="currency">${{ "{:,.0f}".format(cost_breakdown.finishes_total | default(estimate.p80 * 0.10)) }}</td>
                </tr>
                <tr>
                    <td>Appliances (Allowance)</td>
                    <td class="currency">${{ "{:,.0f}".format(cost_breakdown.appliances_total | default(estimate.p80 * 0.08)) }}</td>
                </tr>
                <tr>
                    <td>Permits & Inspections</td>
                    <td class="currency">${{ "{:,.0f}".format(cost_breakdown.permits | default(estimate.p80 * 0.03)) }}</td>
                </tr>
            </tbody>
            <tfoot>
                <tr class="grand-total">
                    <td><strong>Total Project Estimate</strong></td>
                    <td class="currency"><strong>${{ "{:,.0f}".format(estimate.p80) }}</strong></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <p class="text-muted text-small" style="margin-top: 16px;">
        <em>Note: This is a preliminary estimate. Final costs will be confirmed after site visit
        and detailed scope review. Allowance items are budgeted amounts subject to your final selections.</em>
    </p>

    {% else %}
    {# ============= CONTRACTOR VIEW - Full Detailed Breakdown ============= #}
    <h2>Cost Breakdown by Division</h2>

    <p class="text-muted">
        Costs organized according to CSI MasterFormat divisions.
        Each division shows material costs, labor costs, and combined totals.
    </p>

    {% for division in cost_breakdown.get('divisions', []) %}
    <div class="card no-break" style="border-left: 4px solid; border-left-color: inherit;" class="csi-{{ division.code[:2] }}">
        <div class="card-header">
            Division {{ division.code }} - {{ division.name }}
            <span class="badge badge-blue" style="float: right;">
                ${{ "{:,.0f}".format(division.total) }}
            </span>
        </div>

        <table class="table-striped">
            <thead>
                <tr>
                    <th style="width: 40%;">Item</th>
                    <th class="text-right" style="width: 15%;">Quantity</th>
                    <th class="text-right" style="width: 15%;">Unit Cost</th>
                    <th class="text-right" style="width: 15%;">Material</th>
                    <th class="text-right" style="width: 15%;">Labor</th>
                </tr>
            </thead>
            <tbody>
                {% for item in division.get('items', []) %}
                <tr>
                    <td>{{ item.description }}</td>
                    <td class="text-right">{{ item.quantity }} {{ item.unit }}</td>
                    <td class="currency">${{ "{:,.2f}".format(item.unit_cost) }}</td>
                    <td class="currency">${{ "{:,.0f}".format(item.material_cost) }}</td>
                    <td class="currency">${{ "{:,.0f}".format(item.labor_cost) }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="summary-row">
                    <td colspan="3"><strong>Division {{ division.code }} Subtotal</strong></td>
                    <td class="currency"><strong>${{ "{:,.0f}".format(division.material_subtotal) }}</strong></td>
                    <td class="currency"><strong>${{ "{:,.0f}".format(division.labor_subtotal) }}</strong></td>
                </tr>
            </tfoot>
        </table>
    </div>
    {% else %}
    {# Fallback for when no divisions are provided #}
    <div class="card">
        <table class="table-striped">
            <thead>
                <tr>
                    <th>Division</th>
                    <th class="text-right">Material</th>
                    <th class="text-right">Labor</th>
                    <th class="text-right">Total</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Division 06 - Wood & Plastics</td>
                    <td class="currency">${{ "{:,.0f}".format(cost_breakdown.wood_plastics_material | default(0)) }}</td>
                    <td class="currency">${{ "{:,.0f}".format(cost_breakdown.wood_plastics_labor | default(0)) }}</td>
                    <td class="currency">${{ "{:,.0f}".format(cost_breakdown.wood_plastics_total | default(0)) }}</td>
                </tr>
                <tr>
                    <td>Division 09 - Finishes</td>
                    <td class="currency">${{ "{:,.0f}".format(cost_breakdown.finishes_material | default(0)) }}</td>
                    <td class="currency">${{ "{:,.0f}".format(cost_breakdown.finishes_labor | default(0)) }}</td>
                    <td class="currency">${{ "{:,.0f}".format(cost_breakdown.finishes_total | default(0)) }}</td>
                </tr>
                <tr>
                    <td>Division 22 - Plumbing</td>
                    <td class="currency">${{ "{:,.0f}".format(cost_breakdown.plumbing_material | default(0)) }}</td>
                    <td class="currency">${{ "{:,.0f}".format(cost_breakdown.plumbing_labor | default(0)) }}</td>
                    <td class="currency">${{ "{:,.0f}".format(cost_breakdown.plumbing_total | default(0)) }}</td>
                </tr>
                <tr>
                    <td>Division 26 - Electrical</td>
                    <td class="currency">${{ "{:,.0f}".format(cost_breakdown.electrical_material | default(0)) }}</td>
                    <td class="currency">${{ "{:,.0f}".format(cost_breakdown.electrical_labor | default(0)) }}</td>
                    <td class="currency">${{ "{:,.0f}".format(cost_breakdown.electrical_total | default(0)) }}</td>
                </tr>
            </tbody>
        </table>
    </div>
    {% endfor %}

    {# Contractor Cost Summary Table #}
    <div class="card">
        <div class="card-header">Cost Summary</div>
        <table>
            <thead>
                <tr>
                    <th>Category</th>
                    <th class="text-right">Amount</th>
                    <th class="text-right">% of Total</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Material Costs</td>
                    <td class="currency">${{ "{:,.0f}".format(cost_breakdown.total_material | default(estimate.total_cost * 0.55)) }}</td>
                    <td class="text-right">{{ cost_breakdown.material_pct | default(55) }}%</td>
                </tr>
                <tr>
                    <td>Labor Costs</td>
                    <td class="currency">${{ "{:,.0f}".format(cost_breakdown.total_labor | default(estimate.total_cost * 0.35)) }}</td>
                    <td class="text-right">{{ cost_breakdown.labor_pct | default(35) }}%</td>
                </tr>
                <tr>
                    <td>Permits & Fees</td>
                    <td class="currency">${{ "{:,.0f}".format(cost_breakdown.permits | default(estimate.total_cost * 0.03)) }}</td>
                    <td class="text-right">{{ cost_breakdown.permits_pct | default(3) }}%</td>
                </tr>
                <tr>
                    <td>Overhead & Profit</td>
                    <td class="currency">${{ "{:,.0f}".format(cost_breakdown.overhead | default(estimate.total_cost * 0.07)) }}</td>
                    <td class="text-right">{{ cost_breakdown.overhead_pct | default(7) }}%</td>
                </tr>
            </tbody>
            <tfoot>
                <tr class="grand-total">
                    <td><strong>Grand Total</strong></td>
                    <td class="currency"><strong>${{ "{:,.0f}".format(estimate.total_cost) }}</strong></td>
                    <td class="text-right"><strong>100%</strong></td>
                </tr>
            </tfoot>
        </table>
    </div>

    {% if cost_breakdown.internal_notes %}
    <div class="internal-only">
        {{ cost_breakdown.internal_notes }}
    </div>
    {% endif %}
    {% endif %}
</div>
